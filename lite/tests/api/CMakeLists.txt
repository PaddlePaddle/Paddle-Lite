function(lite_cc_test_with_model_and_data TARGET)
    if(NOT WITH_TESTING)
        return()
    endif()

    set(options "")
    set(oneValueArgs MODEL DATA CONFIG SOURCE ARGS)
    set(multiValueArgs "")
    cmake_parse_arguments(args "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if(DEFINED args_MODEL)
        set(ARGS ${ARGS} --model_dir=${LITE_MODEL_DIR}/${args_MODEL})
    endif()
    if(DEFINED args_DATA)
        set(ARGS ${ARGS} --data_dir=${LITE_MODEL_DIR}/${args_DATA})
    endif()
    if(DEFINED args_CONFIG)
        set(ARGS ${ARGS} --config_dir=${LITE_MODEL_DIR}/${args_CONFIG})
    endif()
    if(DEFINED args_ARGS)
        set(ARGS ${ARGS} ${args_ARGS})
    endif()
    set (SOURCE ${TARGET}.cc)
    if(DEFINED args_SOURCE)
        set(SOURCE ${args_SOURCE})
    endif()
    lite_cc_test(${TARGET} SRCS ${SOURCE}
        DEPS ${lite_model_test_DEPS} paddle_api_full kernels
        ARGS ${ARGS} SERIAL)
    
    if(DEFINED args_MODEL)
        add_dependencies(${TARGET} extern_lite_download_${args_MODEL}_tar_gz)
    endif()
    if(DEFINED args_DATA)
        add_dependencies(${TARGET} extern_lite_download_${args_DATA}_tar_gz)
    endif()
    if(DEFINED args_CONFIG)
        add_dependencies(${TARGET} extern_lite_download_${args_CONFIG}_tar_gz)
    endif()
    
    if(LITE_WITH_NNADAPTER)
        set(LINK_FLAGS "-Wl,--version-script ${PADDLE_SOURCE_DIR}/lite/core/lite.map")
        set_target_properties(${TARGET} PROPERTIES LINK_FLAGS "${LINK_FLAGS}")
    endif()
endfunction()

if(LITE_WITH_ARM)
    lite_cc_test_with_model_and_data(test_inception_v4_fp32_arm MODEL inception_v4 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_fp32_arm MODEL mobilenet_v1 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_int8_dygraph_arm MODEL mobilenetv1_int8_dygraph_for_arm DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v2_fp32_arm MODEL mobilenet_v2_relu DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v3_small_x1_0_fp32_arm MODEL mobilenet_v3_small_x1_0 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v3_large_x1_0_fp32_arm MODEL mobilenet_v3_large_x1_0 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_fp32_arm MODEL resnet50 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_squeezenet_fp32_arm MODEL squeezenet DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_transformer_with_mask_fp32_arm MODEL transformer_with_mask_fp32)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_int8_arm MODEL mobilenet_v1_int8_for_arm DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v2_int8_arm MODEL mobilenet_v2_int8_for_arm DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_int8_arm MODEL resnet50_int8_for_arm DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_ocr_lstm_int8_arm MODEL ocr_rec_quant_mul_lstm_for_arm DATA ocr_rec_img_txt)
    lite_cc_test_with_model_and_data(test_nlp_lstm_int8_arm MODEL nlp_quant_lstm_int8_arm DATA nlp_quant_lstm_int8_data_txt)
    lite_cc_test_with_model_and_data(test_lac_crf_fp32_int16_arm MODEL lac_fp32_arm DATA lac_data_txt)
endif()

# Only test on android, disable it for ci error
# if(ANDROID)
#     lite_cc_test_with_model_and_data(test_transformer_nlp2_fp32_arm MODEL transformer_nlp2_fp32_arm DATA transformer_nlp2_data_txt)
# endif()

if(LITE_WITH_NPU)
    lite_cc_test_with_model_and_data(test_inception_v4_fp32_huawei_kirin_npu MODEL inception_v4 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_fp32_huawei_kirin_npu MODEL mobilenet_v1 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v2_fp32_huawei_kirin_npu MODEL mobilenet_v2_relu DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v3_small_x1_0_fp32_huawei_kirin_npu MODEL mobilenet_v3_small_x1_0 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v3_large_x1_0_fp32_huawei_kirin_npu MODEL mobilenet_v3_large_x1_0 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_fp32_huawei_kirin_npu MODEL resnet50 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_squeezenet_fp32_huawei_kirin_npu MODEL squeezenet DATA ILSVRC2012_500)
endif()

if(LITE_WITH_XPU AND NOT LITE_WITH_XTCL)
    lite_cc_test_with_model_and_data(test_bert_base_chinese_fp32_baidu_xpu MODEL bert_base_chinese DATA bert_base_chinese_data)
    lite_cc_test_with_model_and_data(test_bert_fp32_baidu_xpu MODEL bert DATA bert_data)
    lite_cc_test_with_model_and_data(test_ernie_fp32_baidu_xpu MODEL ernie DATA bert_data)
    lite_cc_test_with_model_and_data(test_googlenet_fp32_baidu_xpu MODEL GoogLeNet DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_fp32_baidu_xpu MODEL resnet50 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_vd_fp32_baidu_xpu MODEL resnet50_vd DATA flowers102_val)
    lite_cc_test_with_model_and_data(test_vgg16_fp32_baidu_xpu MODEL vgg16 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_vgg19_fp32_baidu_xpu MODEL VGG19 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_yolov3_darknet53_fp32_baidu_xpu MODEL yolov3_darknet53 DATA roadsign_data_128)
endif()

if(LITE_WITH_RKNPU)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_int8_rockchip_npu MODEL mobilenet_v1_int8_for_rockchip_npu DATA ILSVRC2012_500)
endif()

if(LITE_WITH_METAL)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_fp32_metal MODEL mobilenet_v1 DATA ILSVRC2012_500)
endif()

if(LITE_WITH_NNADAPTER)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_fp32_v1_8_nnadapter                        SOURCE test_mobilenet_v1_fp32_v1_8_nnadapter.cc                        MODEL mobilenet_v1                                 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_int8_per_layer_v1_8_nnadapter              SOURCE test_mobilenet_v1_int8_per_layer_v1_8_nnadapter.cc              MODEL mobilenet_v1_int8_per_layer                  DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_int8_per_channel_v1_8_nnadapter            SOURCE test_mobilenet_v1_int8_per_channel_v1_8_nnadapter.cc            MODEL mobilenet_v1_int8_per_channel                DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_fp32_v1_8_nnadapter                            SOURCE test_resnet50_fp32_v1_8_nnadapter.cc                            MODEL resnet50                                     DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_int8_per_layer_v1_8_nnadapter                  SOURCE test_resnet50_int8_per_layer_v1_8_nnadapter.cc                  MODEL resnet50_int8_per_layer                      DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_ssd_mobilenet_v1_relu_voc_int8_per_layer_v1_8_nnadapter SOURCE test_ssd_mobilenet_v1_relu_voc_int8_per_layer_v1_8_nnadapter.cc MODEL ssd_mobilenet_v1_relu_voc_int8_300_per_layer DATA VOC2012_100)
    lite_cc_test_with_model_and_data(test_ssd_mobilenet_v1_relu_voc_fp32_v1_8_nnadapter           SOURCE test_ssd_mobilenet_v1_relu_voc_fp32_v1_8_nnadapter.cc           MODEL ssd_mobilenet_v1_relu_voc_fp32_300           DATA VOC2012_100)
    lite_cc_test_with_model_and_data(test_ssd_mobilenet_v1_voc_fp32_v2_2_nnadapter                SOURCE test_ssd_mobilenet_v1_voc_fp32_v2_2_nnadapter.cc                MODEL ssd_mobilenet_v1_relu_voc_v2_2               DATA VOC2012_100)
    lite_cc_test_with_model_and_data(test_ssd_vgg16_voc_fp32_v2_2_nnadapter                       SOURCE test_ssd_vgg16_voc_fp32_v2_2_nnadapter.cc                       MODEL ssd_vgg16_voc_v2_2                           DATA VOC2012_100)
    lite_cc_test_with_model_and_data(test_yolov3_darknet53_coco_fp32_v2_2_nnadapter               SOURCE test_yolov3_darknet53_coco_fp32_v2_2_nnadapter.cc               MODEL yolov3_darknet53_coco_v2_2                   DATA COCO2017_100)
    lite_cc_test_with_model_and_data(test_yolov3_mobilenet_v1_coco_fp32_v2_2_nnadapter            SOURCE test_yolov3_mobilenet_v1_coco_fp32_v2_2_nnadapter.cc            MODEL yolov3_mobilenet_v1_coco_v2_2                DATA COCO2017_100)
    lite_cc_test_with_model_and_data(test_yolov3_mobilenet_v3_large_coco_fp32_v2_2_nnadapter      SOURCE test_yolov3_mobilenet_v3_large_coco_fp32_v2_2_nnadapter.cc      MODEL yolov3_mobilenet_v3_large_coco_v2_2          DATA COCO2017_100)
    lite_cc_test_with_model_and_data(test_yolov3_r50vd_dcn_coco_fp32_v2_2_nnadapter               SOURCE test_yolov3_r50vd_dcn_coco_fp32_v2_2_nnadapter.cc               MODEL yolov3_r50vd_dcn_coco_v2_2                   DATA COCO2017_100)
    lite_cc_test_with_model_and_data(test_yolov4_cspdarknet_coco_fp32_v1_8_nnadapter              SOURCE test_yolov4_cspdarknet_coco_fp32_v1_8_nnadapter.cc              MODEL yolov4_cspdarknet_coco_v1_8                  DATA COCO2017_100)
    lite_cc_test_with_model_and_data(test_ppyolo_r50vd_dcn_1x_coco_fp32_v2_2_nnadapter            SOURCE test_ppyolo_r50vd_dcn_1x_coco_fp32_v2_2_nnadapter.cc            MODEL ppyolo_r50vd_dcn_1x_coco_v2_2                DATA COCO2017_100)
    lite_cc_test_with_model_and_data(test_alexnet_fp32_v2_0_nnadapter                             SOURCE test_alexnet_fp32_v2_0_nnadapter.cc                             MODEL AlexNet_v2_0                                 DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_densenet121_fp32_v2_0_nnadapter                         SOURCE test_densenet121_fp32_v2_0_nnadapter.cc                         MODEL DenseNet121_v2_0                             DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_googlenet_fp32_v2_0_nnadapter                           SOURCE test_googlenet_fp32_v2_0_nnadapter.cc                           MODEL GoogLeNet_v2_0                               DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_efficientnet_b0_fp32_v2_0_nnadapter                     SOURCE test_efficientnet_b0_fp32_v2_0_nnadapter.cc                     MODEL EfficientNetB0_v2_0                          DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_inception_v3_fp32_v2_0_nnadapter                        SOURCE test_inception_v3_fp32_v2_0_nnadapter.cc                        MODEL InceptionV3_v2_0                             DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_inception_v4_fp32_v2_0_nnadapter                        SOURCE test_inception_v4_fp32_v2_0_nnadapter.cc                        MODEL InceptionV4_v2_0                             DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v1_fp32_v2_0_nnadapter                        SOURCE test_mobilenet_v1_fp32_v2_0_nnadapter.cc                        MODEL MobileNetV1_v2_0                             DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v2_fp32_v2_0_nnadapter                        SOURCE test_mobilenet_v2_fp32_v2_0_nnadapter.cc                        MODEL MobileNetV2_v2_0                             DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v3_large_x_1_0_fp32_v2_0_nnadapter            SOURCE test_mobilenet_v3_large_x_1_0_fp32_v2_0_nnadapter.cc            MODEL MobileNetV3_large_x1_0_v2_0                  DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_mobilenet_v3_small_x_1_0_fp32_v2_0_nnadapter            SOURCE test_mobilenet_v3_small_x_1_0_fp32_v2_0_nnadapter.cc            MODEL MobileNetV3_small_x1_0_v2_0                  DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet18_fp32_v2_0_nnadapter                            SOURCE test_resnet18_fp32_v2_0_nnadapter.cc                            MODEL ResNet18_v2_0                                DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet50_fp32_v2_0_nnadapter                            SOURCE test_resnet50_fp32_v2_0_nnadapter.cc                            MODEL ResNet50_v2_0                                DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnet101_fp32_v2_0_nnadapter                           SOURCE test_resnet101_fp32_v2_0_nnadapter.cc                           MODEL ResNet101_v2_0                               DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_resnext50_fp32_v2_0_nnadapter                           SOURCE test_resnext50_fp32_v2_0_nnadapter.cc                           MODEL ResNeXt50_32x4d_v2_0                         DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_shufflenet_v2_fp32_v2_0_nnadapter                       SOURCE test_shufflenet_v2_fp32_v2_0_nnadapter.cc                       MODEL ShuffleNetV2_x1_0_v2_0                       DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_squeezenet_v1_fp32_v2_0_nnadapter                       SOURCE test_squeezenet_v1_fp32_v2_0_nnadapter.cc                       MODEL SqueezeNet1_0_v2_0                           DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_vgg16_fp32_v2_0_nnadapter                               SOURCE test_vgg16_fp32_v2_0_nnadapter.cc                               MODEL VGG16_v2_0                                   DATA ILSVRC2012_500)
    lite_cc_test_with_model_and_data(test_vgg19_fp32_v2_0_nnadapter                               SOURCE test_vgg19_fp32_v2_0_nnadapter.cc                               MODEL VGG19_v2_0                                   DATA ILSVRC2012_500)
endif()
